---
title: "2025년 12월 변경 이력"
category: "history"
tier: 2
status: "active"
last_updated: "2025-12-11"
related_docs:
  - path: "docs/roadmap/current-phase.md"
    description: "현재 개발 단계"
  - path: "docs/history/changelog/2025-11.md"
    description: "2025년 11월 변경 이력"
tags:
  - changelog
  - 2025
  - december
---

# 2025년 12월 변경 이력

## 2025-12-11 (Week 17)

### 관리자 명함 관리 기능 완성 ✅

#### 1. 관리자 명함 생성 기능 개선
**파일**: `admin-app/src/lib/api/cards.ts`, `admin-app/src/components/cards/CardCreateModal.tsx`

**문제**: 명함이 없는 신규 회원을 검색할 수 없었음 (business_cards 테이블만 검색)

**해결**:
- `fetchUsersForCardCreate()` 함수를 users 테이블 기반으로 변경
- 이름 + 이메일 동시 검색 지원
  ```typescript
  query.or(`name.ilike.%${search}%,email.ilike.%${search}%`)
  ```

**UI 개선**:
- 검색 placeholder: "사용자 이름 또는 이메일로 검색..."
- 검색 결과에 이메일 표시
- 선택된 사용자 정보: 이름 + 이메일 모두 표시
- "검색 결과가 없습니다" 메시지 추가

**커밋**: `dc707e9` - fix: 명함 생성 시 모든 사용자 검색 가능하도록 개선

#### 2. 명함 삭제 기능 추가
**파일**: `admin-app/src/pages/cards/CardDetailPage.tsx`

**구현 내용**:
- 우측 상단 "삭제" 버튼 추가
- 삭제 확인 모달 구현
  - AlertTriangle 아이콘
  - 명함 소유자 이름 표시
  - "이 작업은 되돌릴 수 없습니다" 경고
- Soft delete 방식 (`is_active = false`)
- 삭제 중 로딩 상태 표시 (스피너 + "삭제 중...")
- 삭제 성공 후 명함 목록으로 자동 이동

**코드**:
```typescript
const handleDelete = async () => {
  if (!id) return
  setIsDeleting(true)
  try {
    await deleteCard(id, false) // soft delete
    alert('명함이 성공적으로 삭제되었습니다')
    navigate('/cards')
  } catch (error) {
    console.error('Error deleting card:', error)
    alert('명함 삭제에 실패했습니다')
  } finally {
    setIsDeleting(false)
    setIsDeleteModalOpen(false)
  }
}
```

**커밋**: `f0c9666` - feat: 명함 상세 페이지에 삭제 기능 추가

#### 3. 명함 목록 필터 개선
**파일**: `admin-app/src/lib/api/cards.ts`

**문제**: 삭제된 명함(is_active=false)이 목록에 계속 표시됨

**해결**:
- `fetchCards()` 기본 동작: `is_active=true`인 명함만 조회
- status 필터가 'all'이어도 활성 명함만 표시

**변경 전**:
```typescript
if (filters.status && filters.status !== 'all') {
  const isActive = filters.status === 'active'
  query = query.eq('is_active', isActive)
}
```

**변경 후**:
```typescript
if (filters.status && filters.status !== 'all') {
  const isActive = filters.status === 'active'
  query = query.eq('is_active', isActive)
} else if (!filters.status || filters.status === 'all') {
  // Default: only show active cards
  query = query.eq('is_active', true)
}
```

**효과**:
- ✅ 삭제된 명함 목록에서 자동 숨김
- ✅ 삭제 후 즉시 목록에서 사라짐
- ✅ status='all' 필터 사용 시에도 활성 명함만 표시

**커밋**: `a7f87b8` - fix: 명함 목록에서 삭제된 명함 숨김 처리

---

## 2025-12-05 (Week 16 계속)

### QR 스캔 추적 시스템 완성 ✅

#### 1. Edge Function IP 주소 처리 수정
**파일**: `react-app/supabase/functions/qr-redirect/index.ts`
- IP 주소 null 허용 (x-forwarded-for 없는 경우)
- "Unknown" 문자열 대신 null 사용 (INET 타입 호환)
- IP 주소 배열에서 첫 번째 값만 추출 (프록시 체인 처리)

**변경 전**:
```typescript
const ipAddress = headers.get('x-forwarded-for') || 'Unknown'
```

**변경 후**:
```typescript
const rawIpAddress = headers.get('x-forwarded-for') ||
                     headers.get('x-real-ip') ||
                     null
const ipAddress = rawIpAddress ? rawIpAddress.split(',')[0].trim() : null
```

#### 2. qr_scans 테이블 스키마 업데이트
**파일**: `react-app/supabase/migrations/20251205000001_add_qr_scans_columns.sql` (신규)
- `browser` 컬럼 추가 (VARCHAR 50)
- `os` 컬럼 추가 (VARCHAR 50)
- `qr_codes.scan_count` 컬럼 추가 (INTEGER DEFAULT 0)
- 인덱스 추가 (`idx_qr_scans_browser`, `idx_qr_scans_os`)

```sql
ALTER TABLE public.qr_scans ADD COLUMN IF NOT EXISTS browser VARCHAR(50);
ALTER TABLE public.qr_scans ADD COLUMN IF NOT EXISTS os VARCHAR(50);
ALTER TABLE public.qr_codes ADD COLUMN IF NOT EXISTS scan_count INTEGER DEFAULT 0;
```

#### 3. QR 코드 URL 표시 개선
**파일**: `react-app/src/components/QRCodeGenerator.tsx`
- Supabase Edge Function URL 대신 g-plat.com/q/ 경로 표시
- 사용자에게 더 깔끔한 URL 제공

**변경 전**:
```typescript
const trackingUrl = `${supabaseUrl}/functions/v1/qr-redirect/${shortCode}`
```

**변경 후**:
```typescript
const trackingUrl = `https://g-plat.com/q/${shortCode}`
```

#### 4. 클라이언트 사이드 리다이렉트 구현
**파일**: `react-app/src/pages/QRRedirectPage.tsx` (신규)
- Vercel rewrites/redirects 순서 문제 해결
- React Router를 통한 Edge Function 리다이렉트

**파일**: `react-app/src/App.tsx`
- `/q/:code` 라우트 추가

**구현 로직**:
```typescript
useEffect(() => {
  if (code) {
    const edgeFunctionUrl = `${SUPABASE_URL}/functions/v1/qr-redirect/${code}`
    window.location.href = edgeFunctionUrl
  }
}, [code])
```

#### 5. Edge Function 재배포
```bash
SUPABASE_ACCESS_TOKEN="xxx" npx supabase functions deploy qr-redirect --no-verify-jwt --project-ref anwwjowwrxdygqyhhckr
```
- `--no-verify-jwt` 플래그 필수 (인증 없이 접근 필요)

### 검증 완료
- ✅ QR 리다이렉트: `/q/pp4emq` → `/card/ds-lee`
- ✅ 스캔 기록 저장: qr_scans 테이블에 정상 저장
- ✅ 통계 조회: 관리자 대시보드에서 스캔 통계 정상 표시
- ✅ 디바이스/브라우저/OS 추적: 모든 정보 정상 수집

### 문서 업데이트
- `CLAUDE.md`: QR 스캔 추적 완성 기록
- `docs/roadmap/current-phase.md`: Week 16 완료 내역 업데이트
- `docs/features/qr-system/README.md`: QR 시스템 문서 신규 작성
- `docs/INDEX.md`: QR 시스템 문서 링크 추가

---

## 2025-12-04 (Week 16)

### QR 코드 시스템 완성 ✅

#### 1. QR 코드 자동 생성 기능
**파일**: `react-app/src/lib/qr.ts` (신규)
- QR 코드 생성 유틸리티 함수 추가
  - `createQRCodeForCard()`: 명함에 QR 코드 생성
  - `getOrCreateQRCodeUrl()`: QR URL 반환
- 6자리 랜덤 short_code 생성
- 중복 체크 및 재시도 로직
- 프로덕션/개발 환경 분기

**파일**: `react-app/src/pages/CreateCardPageOptimized.tsx`
- 명함 생성 시 QR 코드 자동 생성
- 명함 생성 성공 후 `createQRCodeForCard()` 호출
- 커스텀 URL 또는 명함 ID로 QR 타겟 URL 생성

**파일**: `react-app/supabase/migrations/20251204000002_create_qr_for_existing_cards.sql` (신규)
- 기존 명함에 QR 코드 자동 생성 SQL
- `generate_short_code()` 함수: 중복 없는 6자리 코드 생성
- 19개 기존 명함에 QR 코드 생성 완료

**커밋**: `bfe9e49` - feat: 명함 생성 시 QR 코드 자동 생성 기능 추가

#### 2. QR 코드 공유 기능 활성화
**파일**: `react-app/src/components/QRCodeGenerator.tsx`
- Web Share API 구현
  - QR 코드 이미지를 Blob으로 변환
  - `navigator.share()` API 사용
  - Fallback: URL 클립보드 복사
- 통계 버튼 제거 (중복 UI 제거)
- 공유 버튼 활성화

**커밋**: `6019c0d` - fix: QR 코드 기능 개선 및 관리자 RLS 정책 추가

#### 3. QR 리다이렉트 시스템 수정
**파일**: `react-app/vercel.json`
- rewrites 규칙 수정
  - Before: `"source": "/(.*)"`
  - After: `"source": "/:path((?!q).*)*)"`
  - `/q/` 경로를 rewrites에서 제외
- redirects가 정상 작동하도록 개선

**문제**:
- Vercel rewrites가 모든 경로를 index.html로 보내면서 redirects 무시
- QR 코드 스캔 시 빈 페이지 표시

**해결**:
- `/q/:code` 경로만 Edge Function으로 리다이렉트
- 나머지 경로는 SPA index.html로 처리

**테스트**:
```bash
curl -I "https://g-plat.com/q/urh0tm"
# HTTP 302 Found
# Location: https://anwwjowwrxdygqyhhckr.supabase.co/functions/v1/qr-redirect/urh0tm
```

**커밋**: `9b461d8` - fix: QR 코드 리다이렉트 경로 설정 수정

#### 4. Admin QR 관리 개선
**파일**: `admin-app/src/types/admin.ts`
- `QRCodeWithDetails` 인터페이스 수정
  - `business_card.user_id` 추가
  - TypeScript 빌드 에러 해결

**파일**: `react-app/supabase/migrations/20251204000001_qr_admin_policies.sql`
- Admin RLS 정책 추가
  - `is_admin_user()` 함수 사용
  - SELECT, UPDATE 정책 추가
  - 관리자가 모든 QR 코드 조회/수정 가능

**파일**: `admin-app/src/components/layout/Sidebar.tsx`
- QR 코드 메뉴명 변경
  - Before: "QR 코드"
  - After: "QR 코드 관리"

**커밋**:
- `d2fc874` - fix: Admin App QR 관리 TypeScript 타입 정의 수정
- `6019c0d` - fix: QR 코드 기능 개선 및 관리자 RLS 정책 추가

### 기술 개선
- TypeScript 빌드 에러 0개
- Vercel 배포 성공
- Edge Function 리다이렉트 정상화
- QR 코드 시스템 완전 자동화

---

## 2025-12-01 (Week 15)

### Admin App QR 코드 관리 모듈 추가 ✅

#### 파일 변경사항
- `admin-app/src/pages/qr/QrCodesPage.tsx` (신규)
- `admin-app/src/components/qr/QrDetailModal.tsx` (신규)
- `admin-app/src/lib/api/qr.ts` (신규)
- `admin-app/src/types/admin.ts` 업데이트

자세한 내용은 [2025년 11월 변경 이력](2025-11.md) 참조
